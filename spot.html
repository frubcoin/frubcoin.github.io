<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #000000; /* Pure black background */
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- Card Container --- */
        .card {
            width: 340px; /* Fixed width */
            background: #121212; /* Dark gray card */
            border-radius: 12px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* --- Album Art --- */
        .artwork-wrapper {
            width: 300px; /* Standard fixed size */
            height: 300px; /* Standard fixed size */
            margin-bottom: 20px;
        }

        .artwork {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            background: #282828;
            display: block; /* Removes bottom spacing */
        }

        /* --- Text Info --- */
        .info {
            width: 300px; /* Match image width */
            text-align: left;
            margin-bottom: 10px;
        }

        .title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artist {
            font-size: 14px;
            margin: 0;
            color: #a0a0a0; /* Slightly gray artist name */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Progress Bar --- */
        .progress-wrapper {
            width: 300px;
            margin-bottom: 20px;
        }

        .bar-bg {
            width: 100%;
            height: 4px;
            background: #4d4d4d;
            border-radius: 2px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: #1db954; /* Spotify Green */
            width: 0%;
            border-radius: 2px;
        }

        .times {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 12px;
            color: #a0a0a0;
        }

        /* --- Footer Status --- */
        .footer {
            width: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #282828;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #eb4034; /* Red by default */
        }

        .dot.live {
            background: #1db954;
            box-shadow: 0 0 8px rgba(29, 185, 84, 0.6);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; }
        }

        /* --- Offline State --- */
        .hidden { display: none !important; }
        
        .offline-screen {
            text-align: center;
            padding: 40px 0;
        }

        .offline-text {
            margin-top: 15px;
            font-size: 14px;
            color: #a0a0a0;
        }
    </style>
</head>
<body>

    <div class="card">
        
        <!-- Playing State -->
        <div id="playing-view">
            <div class="artwork-wrapper">
                <img id="art" class="artwork" src="https://via.placeholder.com/300" alt="Album">
            </div>
            
            <div class="info">
                <h1 id="title" class="title">Waiting...</h1>
                <p id="artist" class="artist">-</p>
            </div>
            
            <div class="progress-wrapper">
                <div class="bar-bg">
                    <div id="bar" class="bar-fill"></div>
                </div>
                <div class="times">
                    <span id="cur">0:00</span>
                    <span id="tot">0:00</span>
                </div>
            </div>
        </div>

        <!-- Offline State -->
        <div id="offline-view" class="offline-screen hidden">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="#606060">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            <div class="offline-text">
                <span style="color: white; font-weight: bold;">frub is not listening to music :(</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="status-badge">
                <div id="status-dot" class="dot"></div>
                <span id="status-text" style="color: #eb4034;">Offline</span>
            </div>
        </div>
    </div>

    <script>
        const URL = "https://metadata-cult-shades-out.trycloudflare.com";
        const socket = io(URL);

        // Elements
        const viewPlaying = document.getElementById('playing-view');
        const viewOffline = document.getElementById('offline-view');
        const artEl = document.getElementById('art');
        const titleEl = document.getElementById('title');
        const artistEl = document.getElementById('artist');
        const barEl = document.getElementById('bar');
        const curEl = document.getElementById('cur');
        const totEl = document.getElementById('tot');
        const dotEl = document.getElementById('status-dot');
        const textEl = document.getElementById('status-text');

        // Logic
        let playing = false;
        let duration = 0;
        let progress = 0;
        let lastTime = 0;

        // Format time helper
        const fmt = (ms) => {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            s = s % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        };

        // Local animation loop (runs every 16ms for smoothness)
        setInterval(() => {
            if (playing) {
                let passed = Date.now() - lastTime;
                let current = progress + passed;
                
                if (current > duration) current = duration;
                
                let pct = (current / duration) * 100;
                barEl.style.width = `${pct}%`;
                curEl.textContent = fmt(current);
            }
        }, 16);

        // Set status indicator
        const setStatus = (isLive) => {
            if (isLive) {
                dotEl.classList.add('live');
                textEl.style.color = "#1db954";
                textEl.textContent = "LIVE";
            } else {
                dotEl.classList.remove('live');
                textEl.style.color = "#eb4034";
                textEl.textContent = "OFFLINE";
            }
        };

        // Socket events
        socket.on('connect', () => console.log("Connected"));
        
        socket.on('disconnect', () => {
            setStatus(false);
            viewPlaying.classList.add('hidden');
            viewOffline.classList.remove('hidden');
            playing = false;
        });

        socket.on('spotify_update', (data) => {
            // Update text strictly
            titleEl.textContent = data.song;
            artistEl.textContent = data.artist;
            
            // Update image
            artEl.src = data.albumArt || 'https://via.placeholder.com/300';
            
            // Update duration
            duration = data.duration;
            totEl.textContent = fmt(duration);

            if (data.isPlaying) {
                playing = true;
                progress = data.progress;
                lastTime = Date.now();

                // Switch views
                viewPlaying.classList.remove('hidden');
                viewOffline.classList.add('hidden');
                setStatus(true);

                // Instant visual update
                barEl.style.width = `${(progress/duration)*100}%`;
                curEl.textContent = fmt(progress);

            } else {
                playing = false;
                viewPlaying.classList.add('hidden');
                viewOffline.classList.remove('hidden');
                setStatus(false);
            }
        });
    </script>
</body>
</html>
