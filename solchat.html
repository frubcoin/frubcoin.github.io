<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>tryl.chat — Solana Gated Chat</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  
  <style>
    :root {
      --bg: #050505;
      --bg-elevated: #0a0a0a;
      --bg-card: #111111;
      --fg: #ffffff;
      --fg-muted: #666666;
      --fg-dim: #333333;
      --accent: #00ff88;
      --border: #1a1a1a;
      --danger: #ff3366;
    }

    * { box-sizing: border-box; }
    
    html {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--fg);
    }

    body { margin: 0; min-height: 100vh; }

    .font-pixel { font-family: 'Press Start 2P', cursive; }

    /* Pixel aesthetic overlays */
    .scanlines::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.2) 2px, rgba(0, 0, 0, 0.2) 4px);
      pointer-events: none;
      z-index: 9999;
    }

    /* Pixel Borders */
    .pixel-border {
      border: 2px solid var(--border);
      box-shadow: 4px 0 0 0 var(--border), -4px 0 0 0 var(--border), 0 4px 0 0 var(--border), 0 -4px 0 0 var(--border);
    }
    .pixel-border-accent {
      border: 2px solid var(--accent);
      box-shadow: 4px 0 0 0 var(--accent), -4px 0 0 0 var(--accent), 0 4px 0 0 var(--accent), 0 -4px 0 0 var(--accent);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--fg-dim); }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pixelPulse { 0%, 100% { box-shadow: 0 0 0 0 var(--accent); } 50% { box-shadow: 0 0 20px 2px var(--accent); } }
    
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
    .animate-pulse-glow { animation: pixelPulse 2s ease-in-out infinite; }

    /* Buttons */
    .btn-pixel {
      position: relative;
      padding: 12px 24px;
      background: transparent;
      border: 2px solid var(--fg);
      color: var(--fg);
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.1s ease;
      text-transform: uppercase;
    }
    .btn-pixel::before {
      content: '';
      position: absolute;
      top: 4px; left: 4px; right: -4px; bottom: -4px;
      background: var(--fg-dim);
      z-index: -1;
      transition: all 0.1s ease;
    }
    .btn-pixel:hover { transform: translate(2px, 2px); }
    .btn-pixel:hover::before { transform: translate(-2px, -2px); }
    .btn-pixel:active { transform: translate(4px, 4px); }
    .btn-pixel:active::before { transform: translate(-4px, -4px); }
    .btn-pixel.accent { border-color: var(--accent); color: var(--accent); }
    .btn-pixel.accent::before { background: rgba(0, 255, 136, 0.2); }
    .btn-pixel:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-pixel:disabled::before { transform: none; }

    /* Inputs */
    .input-pixel {
      background: var(--bg);
      border: 2px solid var(--border);
      padding: 12px 16px;
      color: var(--fg);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease;
      width: 100%;
    }
    .input-pixel:focus { border-color: var(--accent); }

    /* Room Card */
    .room-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .room-card:hover { border-color: var(--fg-muted); transform: translateY(-2px); }
    .room-card.locked { opacity: 0.6; cursor: not-allowed; }
    .room-card.locked:hover { border-color: var(--danger); transform: none; }

    /* Chat Bubble */
    .chat-bubble {
      background: var(--bg-card);
      border-left: 3px solid var(--fg-muted);
      padding: 12px 16px;
      margin-bottom: 8px;
      max-width: 85%;
    }
    .chat-bubble.own { border-left-color: var(--accent); margin-left: auto; }

    /* Views */
    .view { display: none; opacity: 0; }
    .view.active { display: flex; animation: fadeIn 0.3s ease-out forwards; }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
      .scanlines::before { display: none; }
    }
  </style>
</head>
<body class="scanlines">
  
  <!-- Background Grid -->
  <div class="fixed inset-0 opacity-5 pointer-events-none" style="background-image: linear-gradient(var(--fg-dim) 1px, transparent 1px), linear-gradient(90deg, var(--fg-dim) 1px, transparent 1px); background-size: 20px 20px;"></div>
  
  <!-- Ambient Glow -->
  <div class="fixed top-0 left-1/4 w-96 h-96 rounded-full pointer-events-none" style="background: radial-gradient(circle, rgba(0,255,136,0.1) 0%, transparent 70%); filter: blur(60px);"></div>

  <div id="app" class="relative min-h-screen">
    
    <!-- VIEW: Landing / Onboarding -->
    <div id="view-landing" class="view active flex-col items-center justify-center min-h-screen px-4 py-12">
      
      <!-- Logo -->
      <div class="text-center mb-12 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="inline-block mb-6">
          <svg width="48" height="48" viewBox="0 0 48 48" fill="none" class="mx-auto">
            <rect x="4" y="4" width="40" height="40" fill="none" stroke="var(--accent)" stroke-width="4"/>
            <rect x="12" y="12" width="8" height="8" fill="var(--accent)"/>
            <rect x="28" y="12" width="8" height="8" fill="var(--accent)"/>
            <rect x="12" y="28" width="24" height="4" fill="var(--accent)"/>
          </svg>
        </div>
        <h1 class="font-pixel text-2xl md:text-3xl tracking-wider mb-4">
          <span style="color: var(--accent);">tryl</span><span style="color: var(--fg-muted);">.chat</span>
        </h1>
        <p class="text-sm" style="color: var(--fg-muted);">token-gated conversations on solana</p>
      </div>

      <!-- Onboarding Steps Container -->
      <div id="onboarding-container" class="w-full max-w-md">
        
        <!-- Step 1: Connect -->
        <div id="step-1" class="onboarding-step animate-slide-up" style="animation-delay: 0.2s;">
          <div class="pixel-border bg-[var(--bg-card)] p-8 mb-6">
            <div class="flex items-center gap-3 mb-6">
              <span class="font-pixel text-xs" style="color: var(--accent);">01</span>
              <div class="h-px flex-1" style="background: var(--border);"></div>
              <span class="font-pixel text-xs" style="color: var(--fg-dim);">03</span>
            </div>
            <h2 class="font-pixel text-sm mb-4">Connect Wallet</h2>
            <p class="text-sm mb-6" style="color: var(--fg-muted);">
              Link your Solana wallet to verify on-chain holdings.
            </p>
            <button id="connect-btn" onclick="connectWallet()" class="btn-pixel accent w-full">
              Connect Phantom
            </button>
            <p id="error-msg" class="text-xs mt-4 hidden text-center" style="color: var(--danger);"></p>
          </div>
        </div>

        <!-- Step 2: Verifying -->
        <div id="step-2" class="onboarding-step hidden">
          <div class="pixel-border bg-[var(--bg-card)] p-8 mb-6">
            <div class="flex items-center gap-3 mb-6">
              <span class="font-pixel text-xs" style="color: var(--accent);">02</span>
              <div class="h-px flex-1" style="background: var(--border);"></div>
              <span class="font-pixel text-xs" style="color: var(--fg-dim);">03</span>
            </div>
            <h2 class="font-pixel text-sm mb-4">Scanning Chain</h2>
            <div class="space-y-3">
              <div class="flex items-center gap-3 text-sm">
                <span id="verify-1" class="flex-shrink-0 w-4 h-4 border-2 border-[var(--fg-dim)]"></span>
                <span>Connecting to RPC...</span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <span id="verify-2" class="flex-shrink-0 w-4 h-4 border-2 border-[var(--fg-dim)]"></span>
                <span>Fetching SPL Tokens...</span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <span id="verify-3" class="flex-shrink-0 w-4 h-4 border-2 border-[var(--fg-dim)]"></span>
                <span>Calculating access rights...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Complete -->
        <div id="step-3" class="onboarding-step hidden">
          <div class="pixel-border-accent bg-[var(--bg-card)] p-8 mb-6 animate-pulse-glow">
            <div class="flex items-center gap-3 mb-6">
              <span class="font-pixel text-xs" style="color: var(--accent);">03</span>
              <div class="h-px flex-1" style="background: var(--accent);"></div>
              <span class="font-pixel text-xs" style="color: var(--accent);">03</span>
            </div>
            <h2 class="font-pixel text-sm mb-2" style="color: var(--accent);">Access Granted</h2>
            <p class="text-sm mb-6" style="color: var(--fg-muted);">
              Verified. You have access to <span id="room-count" style="color: var(--accent);">0</span> token-gated rooms.
            </p>
            <div class="flex items-center gap-2 text-xs mb-6" style="color: var(--fg-muted);">
              <span id="wallet-display" class="font-mono"></span>
              <button onclick="copyWallet()" class="hover:text-[var(--accent)] transition-colors" title="Copy Address">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2"/>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
              </button>
            </div>
            <button onclick="enterLobby()" class="btn-pixel w-full">
              Enter Lobby
            </button>
          </div>
        </div>
        
      </div>
      
      <div class="text-center mt-8 animate-fade-in" style="animation-delay: 0.5s;">
        <p class="text-xs flex items-center justify-center gap-2" style="color: var(--fg-dim);">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Read-only access. No private keys shared.
        </p>
      </div>
    </div>

    <!-- VIEW: Lobby -->
    <div id="view-lobby" class="view flex-col min-h-screen">
      <header class="border-b-2 p-4" style="border-color: var(--border); background: var(--bg-elevated);">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
          <div class="flex items-center gap-3">
            <svg width="24" height="24" viewBox="0 0 48 48" fill="none">
              <rect x="4" y="4" width="40" height="40" fill="none" stroke="var(--accent)" stroke-width="4"/>
              <rect x="12" y="12" width="8" height="8" fill="var(--accent)"/>
              <rect x="28" y="12" width="8" height="8" fill="var(--accent)"/>
              <rect x="12" y="28" width="24" height="4" fill="var(--accent)"/>
            </svg>
            <span class="font-pixel text-xs"><span style="color: var(--accent);">tryl</span><span style="color: var(--fg-muted);">.chat</span></span>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-xs hidden sm:inline font-mono" style="color: var(--fg-muted);" id="wallet-short"></span>
            <button onclick="disconnectWallet()" class="text-xs hover:text-[var(--danger)] transition-colors" style="color: var(--fg-muted);">Disconnect</button>
          </div>
        </div>
      </header>

      <main class="flex-1 p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="font-pixel text-sm">Available Rooms</h2>
            <span class="text-xs" style="color: var(--fg-muted);"><span id="accessible-count">0</span> accessible</span>
          </div>
          <div id="rooms-grid" class="grid gap-4 md:grid-cols-2"></div>
        </div>
      </main>
    </div>

    <!-- VIEW: Chat -->
    <div id="view-chat" class="view flex-col h-screen">
      <header class="border-b-2 p-4 flex-shrink-0" style="border-color: var(--border); background: var(--bg-elevated);">
        <div class="max-w-4xl mx-auto flex items-center gap-4">
          <button onclick="leaveRoom()" class="hover:text-[var(--accent)] transition-colors" style="color: var(--fg-muted);">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          </button>
          <div class="flex-1">
            <h2 id="chat-room-name" class="font-pixel text-xs"></h2>
            <p id="chat-room-desc" class="text-xs mt-1" style="color: var(--fg-muted);"></p>
          </div>
          <div class="flex items-center gap-2 text-xs" style="color: var(--fg-muted);">
            <span class="w-2 h-2 bg-[var(--accent)] inline-block"></span>
            <span id="online-count">0</span> online
          </div>
        </div>
      </header>

      <main id="chat-messages" class="flex-1 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto space-y-2"></div>
      </main>

      <footer class="border-t-2 p-4 flex-shrink-0" style="border-color: var(--border); background: var(--bg-elevated);">
        <div class="max-w-4xl mx-auto">
          <form onsubmit="sendMessage(event)" class="flex gap-3">
            <input type="text" id="chat-input" class="input-pixel" placeholder="Type a message..." autocomplete="off">
            <button type="submit" class="btn-pixel accent px-6">Send</button>
          </form>
        </div>
      </footer>
    </div>

  </div>

  <script>
    // =============================================
    // CONFIGURATION & STATE
    // =============================================
    
    // Use a public RPC endpoint (for demo purposes). 
    // For production, use a dedicated provider (Helius, QuickNode, Alchemy).
    const RPC_ENDPOINT = 'https://api.mainnet-beta.solana.com';
    
    let connection = null;
    let walletPubKey = null;
    let userBalances = {}; // Stores: { "SYMBOL": float_amount }
    let currentRoom = null;
    
    // Messages Store (In-memory for frontend-only demo)
    const messages = {};

    // Token Mint Addresses (Mainnet)
    const TOKENS = {
      SOL: { mint: null, decimals: 9, name: 'Solana' },
      USDC: { mint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', decimals: 6, name: 'USDC' },
      BONK: { mint: 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263', decimals: 5, name: 'BONK' },
      JUP:  { mint: 'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN', decimals: 6, name: 'Jupiter' },
      WIF:  { mint: 'EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm', decimals: 6, name: 'dogwifhat' }
    };

    // Room Configuration
    const rooms = [
      { id: 'general', name: 'General', description: 'Public lobby for all verified wallets', requirement: null, members: 1247, online: 89 },
      { id: 'sol-whales', name: 'SOL Whales', description: 'For holders with 10+ SOL', requirement: { token: 'SOL', amount: 10 }, members: 342, online: 28 },
      { id: 'usdc-club', name: 'USDC Club', description: 'Stablecoin holders circle', requirement: { token: 'USDC', amount: 100 }, members: 892, online: 56 },
      { id: 'bonk-army', name: 'BONK Army', description: '1M+ BONK Holders', requirement: { token: 'BONK', amount: 1000000 }, members: 45, online: 12 },
      { id: 'jup-crew', name: 'JUP Crew', description: 'Jupiter exchange enthusiasts', requirement: { token: 'JUP', amount: 10 }, members: 567, online: 34 },
      { id: 'wif-gang', name: 'WIF Gang', description: 'dogwifhat community', requirement: { token: 'WIF', amount: 1 }, members: 723, online: 41 }
    ];

    // Seed initial messages
    rooms.forEach(r => {
      messages[r.id] = [
        { user: 'system', text: `Welcome to ${r.name}.`, time: getTimestamp(), type: 'system' }
      ];
    });

    // =============================================
    // UTILITY FUNCTIONS
    // =============================================
    
    function getTimestamp() {
      const d = new Date();
      return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    function shortenKey(key) {
      if (!key) return '????';
      const str = key.toString();
      return `${str.slice(0, 4)}...${str.slice(-4)}`;
    }

    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      const v = document.getElementById(`view-${id}`);
      if(v) v.classList.add('active');
    }

    function setStep(n) {
      document.querySelectorAll('.onboarding-step').forEach(s => s.classList.add('hidden'));
      const s = document.getElementById(`step-${n}`);
      if(s) s.classList.remove('hidden');
    }

    function checkAccess(room) {
      if (!room.requirement) return true;
      const bal = userBalances[room.requirement.token] || 0;
      return bal >= room.requirement.amount;
    }

    // =============================================
    // SOLANA INTEGRATION
    // =============================================

    async function connectWallet() {
      const btn = document.getElementById('connect-btn');
      const errEl = document.getElementById('error-msg');
      btn.disabled = true;
      btn.textContent = 'Connecting...';
      errEl.classList.add('hidden');

      try {
        if (!window.solana || !window.solana.isPhantom) {
           // If on desktop, prompt install. On mobile, deep link might work but usually requires app browser.
          throw new Error('Phantom wallet not found. Please install Phantom extension.');
        }

        // Request connection
        const resp = await window.solana.connect();
        walletPubKey = resp.publicKey;
        
        setStep(2); // Move to verification UI
        
        await verifyHoldings();

      } catch (err) {
        console.error(err);
        errEl.textContent = err.message;
        errEl.classList.remove('hidden');
        btn.disabled = false;
        btn.textContent = 'Connect Phantom';
      }
    }

    async function verifyHoldings() {
      try {
        // 1. Connect to RPC
        connection = new solanaWeb3.Connection(RPC_ENDPOINT, 'confirmed');

        // 2. Get SOL Balance
        document.getElementById('verify-1').innerHTML = '⟳';
        const lamports = await connection.getBalance(walletPubKey);
        userBalances['SOL'] = lamports / solanaWeb3.LAMPORTS_PER_SOL;
        document.getElementById('verify-1').innerHTML = '<span style="color:var(--accent)">✓</span>';

        // 3. Get SPL Tokens
        document.getElementById('verify-2').innerHTML = '⟳';
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
          walletPubKey, 
          { programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
        );
        
        // Parse SPL balances
        tokenAccounts.value.forEach(acc => {
          const info = acc.account.data.parsed.info;
          const mint = info.mint;
          const amount = info.tokenAmount.uiAmount; 

          // Match against our TOKENS dictionary
          Object.keys(TOKENS).forEach(ticker => {
            if (TOKENS[ticker].mint === mint) {
              userBalances[ticker] = amount;
            }
          });
        });
        document.getElementById('verify-2').innerHTML = '<span style="color:var(--accent)">✓</span>';

        // 4. Finalize
        document.getElementById('verify-3').innerHTML = '⟳';
        await new Promise(r => setTimeout(r, 600)); // UX delay
        
        const accessible = rooms.filter(r => checkAccess(r)).length;
        document.getElementById('verify-3').innerHTML = '<span style="color:var(--accent)">✓</span>';
        
        // Update UI
        document.getElementById('room-count').textContent = accessible;
        document.getElementById('wallet-display').textContent = shortenKey(walletPubKey);
        
        setTimeout(() => setStep(3), 500);

      } catch (err) {
        console.error(err);
        alert("Error fetching balances: " + err.message);
        disconnectWallet(); // Reset state on failure
      }
    }

    function disconnectWallet() {
      if (window.solana && window.solana.isConnected) {
        window.solana.disconnect();
      }
      walletPubKey = null;
      userBalances = {};
      connection = null;
      
      document.getElementById('connect-btn').disabled = false;
      document.getElementById('connect-btn').textContent = 'Connect Phantom';
      
      // Reset UI
      ['verify-1', 'verify-2', 'verify-3'].forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '';
        el.className = 'flex-shrink-0 w-4 h-4 border-2 border-[var(--fg-dim)]';
      });
      
      setStep(1);
      showView('landing');
    }

    // =============================================
    // LOBBY RENDERING
    // =============================================

    function enterLobby() {
      showView('lobby');
      document.getElementById('wallet-short').textContent = shortenKey(walletPubKey);
      renderRooms();
    }

    function renderRooms() {
      const grid = document.getElementById('rooms-grid');
      const accessibleCount = rooms.filter(r => checkAccess(r)).length;
      document.getElementById('accessible-count').textContent = accessibleCount;

      grid.innerHTML = rooms.map((room, idx) => {
        const hasAccess = checkAccess(room);
        const balance = room.requirement ? (userBalances[room.requirement.token] || 0) : 0;
        
        return `
          <div 
            class="room-card ${hasAccess ? '' : 'locked'}"
            onclick="${hasAccess ? `enterRoom('${room.id}')` : `showLockedMsg('${room.id}')`}"
            style="animation: slideUp 0.3s ease-out forwards; animation-delay: ${idx * 0.05}s; opacity: 0;"
          >
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="font-pixel text-xs mb-1">${room.name}</h3>
                <span class="text-xs font-mono px-2 py-1 inline-block mt-1" style="background: var(--bg); color: ${hasAccess ? 'var(--accent)' : 'var(--fg-muted)'};">
                  ${hasAccess ? 'ACCESS' : 'LOCKED'}
                </span>
              </div>
              ${!hasAccess ? `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
              ` : ''}
            </div>
            <p class="text-xs mb-4" style="color: var(--fg-muted);">${room.description}</p>
            ${room.requirement ? `
              <div class="text-xs mb-4" style="color: var(--fg-dim);">
                <p>Requires: ${room.requirement.amount.toLocaleString()} ${room.requirement.token}</p>
                <p style="color: ${balance >= room.requirement.amount ? 'var(--accent)' : 'var(--danger)'}">
                  You have: ${balance.toLocaleString()}
                </p>
              </div>
            ` : ''}
            <div class="flex items-center gap-4 text-xs" style="color: var(--fg-dim);">
              <span>${room.members} members</span>
              <span class="flex items-center gap-1">
                <span class="w-2 h-2 bg-[var(--accent)] inline-block"></span>
                ${room.online} online
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function showLockedMsg(id) {
      const room = rooms.find(r => r.id === id);
      alert(`You need at least ${room.requirement.amount} ${room.requirement.token} to enter.`);
    }

    // =============================================
    // CHAT FUNCTIONALITY
    // =============================================

    function enterRoom(id) {
      const room = rooms.find(r => r.id === id);
      if (!room || !checkAccess(room)) return;

      currentRoom = room;
      document.getElementById('chat-room-name').textContent = room.name;
      document.getElementById('chat-room-desc').textContent = room.description;
      document.getElementById('online-count').textContent = room.online;
      
      renderMessages();
      showView('chat');
      
      setTimeout(() => document.getElementById('chat-input').focus(), 100);
    }

    function leaveRoom() {
      currentRoom = null;
      showView('lobby');
    }

    function renderMessages() {
      const container = document.getElementById('chat-messages').querySelector('.space-y-2');
      const msgs = messages[currentRoom.id] || [];
      
      container.innerHTML = msgs.map(m => `
        <div class="chat-bubble ${m.type === 'system' ? 'border-l-[var(--fg-dim)] text-center w-full' : ''} ${m.user === 'you' ? 'own' : ''}">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-xs font-mono" style="color: ${m.user === 'you' ? 'var(--accent)' : 'var(--fg)'};">${m.user}</span>
            <span class="text-xs" style="color: var(--fg-dim);">${m.time}</span>
          </div>
          <p class="text-sm" style="color: var(--fg);">${m.text}</p>
        </div>
      `).join('');

      const scrollEl = document.getElementById('chat-messages');
      scrollEl.scrollTop = scrollEl.scrollHeight;
    }

    function sendMessage(e) {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      
      if (!text || !currentRoom) return;

      messages[currentRoom.id].push({
        user: 'you',
        text: text,
        time: getTimestamp()
      });

      input.value = '';
      renderMessages();
      
      // Simulate a reply
      if (Math.random() > 0.3) simulateReply();
    }

    function simulateReply() {
      const responses = [
        "Interesting perspective.",
        "Check the charts.",
        "Diamond hands only.",
        "Just verified my holdings.",
        "The UI is clean.",
        "Bullish."
      ];
      const users = ['anon_01', 'solana_dev', 'crypto_degen', 'whale_alert'];

      setTimeout(() => {
        if (!currentRoom) return;
        messages[currentRoom.id].push({
          user: users[Math.floor(Math.random() * users.length)],
          text: responses[Math.floor(Math.random() * responses.length)],
          time: getTimestamp()
        });
        renderMessages();
      }, 1200 + Math.random() * 1000);
    }

    function copyWallet() {
      if(walletPubKey) {
        navigator.clipboard.writeText(walletPubKey.toString());
        alert("Address copied!");
      }
    }

    // =============================================
    // EVENT LISTENERS & INIT
    // =============================================

    // Handle Phantom reconnection (if user refreshes page)
    if (window.solana) {
      window.solana.on('connect', () => {
        // Auto-reconnect logic could go here, but for a gated app, 
        // forcing the user to click "Connect" again is often safer/clearer.
        console.log("Phantom connected.");
      });
      
      window.solana.on('disconnect', () => {
        console.log("Phantom disconnected.");
        // If the user disconnects from the extension popup, reflect it in UI
        if(walletPubKey) {
          disconnectWallet();
        }
      });
    }
    
  </script>
</body>
</html>
